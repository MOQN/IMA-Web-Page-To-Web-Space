<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebXR with Microphone Input</title>
  <!-- import the three.js library -->
  <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
  <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/"
        }
      }
    </script>
  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import { BoxLineGeometry } from "three/addons/geometries/BoxLineGeometry.js";
    import { XRButton } from "three/addons/webxr/XRButton.js";
    import { XRControllerModelFactory } from "three/addons/webxr/XRControllerModelFactory.js";
    window.THREE = THREE;
    window.OrbitControls = OrbitControls;
    window.BoxLineGeometry = BoxLineGeometry;
    window.XRButton = XRButton;
    window.XRControllerModelFactory = XRControllerModelFactory;
    let scene, camera, renderer, controller;

    // Initialize Three.js scene
    function init() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // Set up WebXR
      navigator.xr.requestDevice()
        .then((device) => {
          device.supportsSession({ immersive: true, exclusive: true })
            .then(() => {
              // Create XR controller
              controller = renderer.xr.getController(0);
              scene.add(controller);

              // Start XR session
              device.requestSession({ immersive: true, exclusive: true })
                .then((session) => {
                  renderer.xr.setSession(session);
                  session.addEventListener('end', onSessionEnd);
                });
            })
            .catch(console.error);
        });

      // Set up camera and scene
      camera.position.set(0, 1.6, 0);
      camera.lookAt(0, 1.6, -1);
      scene.background = new THREE.Color(0xeeeeee);

      // Create a cube for visualization
      const geometry = new THREE.BoxGeometry();
      const material = new THREE.MeshBasicMaterial({ color: 0x3498db });
      const cube = new THREE.Mesh(geometry, material);
      cube.position.set(0, 1.6, -3);
      scene.add(cube);

      // Create an AudioListener and connect it to the XR controller
      const listener = new THREE.AudioListener();
      controller.add(listener);

      // Create an AudioAnalyser for visualization
      const audio = new THREE.Audio(listener);
      const analyser = new THREE.AudioAnalyser(audio, 256);
      cube.userData.analyser = analyser;

      // Request access to the microphone
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then((stream) => {
          const audioContext = listener.context;
          const mediaStreamSource = audioContext.createMediaStreamSource(stream);
          audio.setNodeSource(mediaStreamSource);
        })
        .catch(console.error);

      // Handle frame updates
      renderer.setAnimationLoop(() => {
        animate();
      });
    }

    // Handle XR session end
    function onSessionEnd() {
      console.log('XR session ended.');
    }

    // Animation loop
    function animate() {
      // Use audio data for visualization
      const cube = scene.children.find(child => child instanceof THREE.Mesh);
      const analyser = cube.userData.analyser;

      if (analyser) {
        const dataArray = analyser.getFrequencyData();
        const average = dataArray.reduce((acc, value) => acc + value, 0) / dataArray.length;

        // Use the data for your visualization
        // (replace this with your specific audio visualization logic)
        cube.scale.y = 1 + average / 128;
      }

      // Render the scene
      renderer.render(scene, camera);
    }

    // Initialize the Three.js scene
    init();
  </script>
</head>

<body>
  <script>
    //
  </script>
</body>

</html>